<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xiaozhi Web Client (Fixed)</title>
    <script src="https://cdn.jsdelivr.net/npm/opus-decoder@0.7.11/dist/opus-decoder.min.js" charset="UTF-8"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background: #f0f2f5; }
        #log { height: 400px; overflow-y: auto; background: #000; color: #0f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; }
        #input-area { margin-top: 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }
        button { padding: 12px 24px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:hover { background: #0056b3; }
        h1 { text-align: center; color: #333; }
    </style>
</head>
<body>
    <h1>üó£Ô∏è Xiaozhi Web Client (ƒê√£ s·ª≠a session_id)</h1>
    <div id="log"></div>
    <div id="input-area">
        <input type="text" id="messageInput" placeholder="G√µ tin nh·∫Øn r·ªìi nh·∫•n Enter ho·∫∑c G·ª≠i..." autofocus>
        <button onclick="sendMessage()">G·ª≠i</button>
    </div>

    <script>
        const logElement = document.getElementById('log');
        const inputElement = document.getElementById('messageInput');

        let ws = null;
        let sessionId = null;
        let audioContext = null;
        let audioQueue = [];
        let isPlaying = false;
        let opusDecoder = null;

        const SERVER_URL = "wss://api.tenclass.net/xiaozhi/v1/";

        function log(message) {
            const time = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div>[${time}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
                await audioContext.resume();
                log("‚úÖ Web Audio Context: 48000Hz");
            }

            if (!opusDecoder) {
                const { OpusDecoder } = window["opus-decoder"];
                opusDecoder = new OpusDecoder({ channels: 1, sampleRate: 48000 });
                await opusDecoder.ready;
                await opusDecoder.reset();
                log("‚úÖ Opus Decoder s·∫µn s√†ng (48000Hz)");
            }
        }

        async function decodeOpusPacket(uint8Array) {
            try {
                const { channelData } = await opusDecoder.decodeFrame(uint8Array);
                const pcmFloat32 = channelData[0];

                for (let i = 0; i < pcmFloat32.length; i++) {
                    pcmFloat32[i] *= 3.0; // TƒÉng volume m·∫°nh h∆°n ch√∫t
                }

                audioQueue.push(pcmFloat32);
                if (!isPlaying) playNextChunk();
            } catch (e) {
                log("‚ùå L·ªói decode: " + e.message);
            }
        }

        async function playNextChunk() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }
            isPlaying = true;
            const pcmFloat32 = audioQueue.shift();
            const audioBuffer = audioContext.createBuffer(1, pcmFloat32.length, 48000);
            audioBuffer.getChannelData(0).set(pcmFloat32);

            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.onended = playNextChunk;
            source.start();
        }

        function connect() {
            ws = new WebSocket(SERVER_URL);

            ws.onopen = () => {
                log("‚úÖ K·∫øt n·ªëi WebSocket th√†nh c√¥ng!");
                ws.send(JSON.stringify({
                    type: "hello",
                    version: 3,
                    features: { mcp: true },
                    transport: "websocket",
                    audio_params: {
                        format: "opus",
                        sample_rate: 48000,
                        channels: 1,
                        frame_duration: 60
                    }
                }));
                log("üì§ ƒê√£ g·ª≠i message hello (y√™u c·∫ßu 48000Hz)");
            };

            ws.onmessage = async (event) => {
                if (typeof event.data === 'string') {
                    log(`[Server text] ${event.data}`);

                    // T√¨m session_id trong b·∫•t k·ª≥ message n√†o
                    const match = event.data.match(/"session_id"\s*:\s*"([^"]+)"/);
                    if (match && !sessionId) {
                        sessionId = match[1];
                        log(`‚úÖ ƒê√£ nh·∫≠n session_id: ${sessionId}`);
                        log("üöÄ B√¢y gi·ªù b·∫°n c√≥ th·ªÉ g·ª≠i tin nh·∫Øn!");

                        // T·ª± ƒë·ªông g·ª≠i tin nh·∫Øn test ƒë·ªÉ k√≠ch ho·∫°t (th∆∞·ªùng server g·ª≠i session_id k√®m TTS)
                        setTimeout(() => {
                            if (inputElement.value === '') {
                                inputElement.value = "xin ch√†o";
                                sendMessage();
                            }
                        }, 1000);
                    }

                    if (event.data.includes("\"type\":\"tts_start\"")) log("üîä B·∫Øt ƒë·∫ßu ph√°t gi·ªçng n√≥i...");
                    if (event.data.includes("\"type\":\"tts_end\"")) log("üèÅ K·∫øt th√∫c gi·ªçng n√≥i.");
                } else {
                    const arrayBuffer = await event.data.arrayBuffer();
                    const uint8 = new Uint8Array(arrayBuffer);
                    decodeOpusPacket(uint8);
                }
            };

            ws.onclose = () => log("‚ùå K·∫øt n·ªëi ƒë√≥ng - th·ª≠ reload trang ƒë·ªÉ k·∫øt n·ªëi l·∫°i.");
            ws.onerror = () => log("‚ùå L·ªói WebSocket (ki·ªÉm tra m·∫°ng ho·∫∑c server).");
        }

        function sendMessage() {
            const text = inputElement.value.trim();
            if (!text) return;
            if (!sessionId) {
                log("‚ö† Vui l√≤ng ƒë·ª£i nh·∫≠n session_id t·ª´ server tr∆∞·ªõc khi g·ª≠i!");
                return;
            }

            const msg = {
                session_id: sessionId,
                type: "listen",
                state: "detect",
                text: text
            };

            ws.send(JSON.stringify(msg));
            log(`üì§ B·∫°n: ${text}`);
            inputElement.value = '';
        }

        inputElement.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        window.onload = async () => {
            await initAudio();
            connect();

            // Test beep
            const oscillator = audioContext.createOscillator();
            oscillator.frequency.value = 440;
            oscillator.connect(audioContext.destination);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.2);
            log("üîä Beep test ‚Äì n·∫øu nghe th·∫•y th√¨ loa OK!");
            log("‚è≥ ƒêang ch·ªù server ph·∫£n h·ªìi hello v√† session_id...");
        };
    </script>
</body>

</html>
