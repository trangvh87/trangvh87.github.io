<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SePay Transaction Monitor</title>
    <style>
        body { font-family: sans-serif; margin: 20px; line-height: 1.6; }
        #log { background: #f4f4f4; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .transaction { border-bottom: 1px solid #ddd; padding: 5px 0; }
        .new { color: green; font-weight: bold; }
        .status { margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <h2>Giám sát giao dịch SePay</h2>
    <div class="status" id="status">Khởi tạo...</div>
    <div id="log">
        <div>Đang chờ giao dịch mới...</div>
    </div>

    <script>
        const API_TOKEN = '';
        const BASE_URL = 'https://my.sepay.vn/userapi/transactions/list';
        let sinceId = 0;
        let isFirstLoad = true;

        async function fetchTransactions() {
            try {
                const url = `${BASE_URL}?since_id=${sinceId}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.status === 200 && data.transactions.length > 0) {
                    // Sắp xếp ID từ thấp đến cao để xử lý theo thứ tự thời gian
                    const transactions = data.transactions.sort((a, b) => parseInt(a.id) - parseInt(b.id));

                    transactions.forEach(trans => {
                        // Nếu không phải lần load đầu tiên, hiển thị thông báo
                        if (!isFirstLoad) {
                            showNotification(trans);
                            appendLog(trans);
                        }
                        
                        // Cập nhật sinceId là ID lớn nhất
                        if (parseInt(trans.id) > sinceId) {
                            sinceId = parseInt(trans.id);
                        }
                    });

                    if (isFirstLoad) {
                        document.getElementById('status').innerText = `Đã tải lịch sử. Last ID: ${sinceId}`;
                        isFirstLoad = false;
                    }
                }
            } catch (error) {
                console.error('Lỗi khi gọi API:', error);
                document.getElementById('status').innerText = 'Lỗi kết nối API!';
            }
        }

        function appendLog(trans) {
            const logDiv = document.getElementById('log');
            const item = document.createElement('div');
            item.className = 'transaction new';
            item.innerHTML = `[${trans.transaction_date}] +${trans.amount_in}đ - Nội dung: ${trans.transaction_content}`;
            logDiv.prepend(item);
        }

        function showNotification(trans) {
            // Hiển thị thông báo trình duyệt nếu được phép
            if (Notification.permission === "granted") {
                new Notification("Giao dịch mới!", {
                    body: `Số tiền: ${trans.amount_in}đ\nNội dung: ${trans.transaction_content}`,
                    icon: "https://sepay.vn/favicon.ico"
                });
            } else {
                // Nếu chưa xin quyền thì báo qua console hoặc alert
                console.log(`Giao dịch mới: ${trans.amount_in} - ${trans.transaction_content}`);
            }
        }

        // Xin quyền thông báo
        if (Notification.permission !== "denied") {
            Notification.requestPermission();
        }

        // Chạy lần đầu ngay lập tức
        fetchTransactions();

        // Thiết lập vòng lặp 1 giây (1000ms)
        setInterval(fetchTransactions, 1000);

    </script>
</body>
</html>

